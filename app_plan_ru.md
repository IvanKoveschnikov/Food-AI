# Food AI — концепция и общий план разработки

## 1. Назначение приложения

Food AI — это персональный дневник питания с ИИ‑помощником. Основные задачи:
- фиксировать, что пользователь ест каждый день (со фото и без);
- автоматически распознавать блюдо и его состав по фото или описанию с помощью ИИ;
- считать и визуализировать рацион по дням;
- вести личный список продуктов и шаблонов блюд, чтобы добавлять повторяющиеся блюда быстрее.

Целевая аудитория:
- люди, которые хотят отслеживать питание (ПП, ЗОЖ, похудение, набор массы);
- пользователи, которым лень вручную забивать ингредиенты и хочется «сфоткал — сохранил».

## 2. Общий сценарий работы пользователя

1. Пользователь регистрируется/логинится по email и паролю (Supabase auth).
2. Попадает на главный экран с календарём:
   - выбирает дату;
   - видит список блюд за день.
3. Добавление блюда:
   - вариант 1: через экран «Фото» — делает фото или выбирает из галереи;
   - вариант 2: через экран «Добавить без фото» — вводит название и/или описание.
4. Приложение отправляет фото/описание в ИИ (OpenRouter):
   - получает название блюда, краткое описание и список продуктов на русском;
   - предлагает пользователю отредактировать список продуктов, добавить свои.
5. При сохранении:
   - создаётся запись блюда в таблице `saved_dishes`;
   - создаются связи «блюдо — продукт» в `dish_products`;
   - фото загружается в Supabase Storage (`dish-images`) и привязывается по URL.
6. Пользователь может:
   - открыть блюдо и посмотреть подробный состав;
   - редактировать продукты и описание;
   - управлять своими продуктами и шаблонами блюд в профиле.

## 3. Архитектура и технологии

- Клиент: Flutter 3 (Material 3, Riverpod, GoRouter).
- Бэкенд: Supabase (PostgreSQL, Auth, Storage, RLS‑политики).
- ИИ: OpenRouter (`openrouter/free`) для анализа фото/текста.

Основные слои:
- `features/*` — UI‑экраны и логика презентации:
  - `home` — календарь и список блюд;
  - `camera` — добавление по фото и без фото;
  - `dish_detail` — экран конкретного блюда;
  - `profile` — профиль, списки продуктов и шаблонов;
  - `auth` — логин/регистрация.
- `services/*` — работа с Supabase и ИИ:
  - `dishes_service.dart`, `dish_products_service.dart`, `products_service.dart`;
  - `storage_service.dart` — загрузка изображений;
  - `openrouter_service.dart`, `ai_service.dart` — запросы в OpenRouter и заглушки.
- `core/*`:
  - `router` — маршрутизация и табы;
  - `theme` — темы (графитовый/чёрный/белый);
  - `auth` — слушатель авторизации;
  - `config` — env и supabaseConfig.

## 4. Ключевые сущности и таблицы

- `saved_dishes` — блюда пользователя:
  - `id`, `user_id`, `name`, `date`, `image_url`, `description`,
    `created_at`, `updated_at`.
- `products` — продукты (глобальные и пользовательские):
  - `id`, `name`, `scope ('global'|'user')`, `created_by`, `created_at`.
- `dish_products` — связь «блюдо — продукт»:
  - `id`, `dish_id`, `product_id`, `is_user_added`, `created_at`.
- `profiles` — профиль пользователя (имя, аватар).
- `dish_templates`, `dish_template_products` — шаблоны блюд и их состав.
- Storage bucket `dish-images` — файлы вида `{user_id}/{dish_id}.jpg`.

## 5. План развития и текущее состояние

### 5.1 Базовая стабильность (MVP)

- Реализовано:
  - поток «сфоткал блюдо → ИИ → сохранил» (экраны Camera и Home);
  - создание записей в `saved_dishes` и связей в `dish_products`;
  - хранение фото в Storage bucket `dish-images` и подтягивание по signed URL;
  - добавление блюда без фото через экран `AddDishNoPhoto`;
  - ручное редактирование продуктов через экран блюда и экраны продуктов/шаблонов.
- В планах:
  - дополнительно покрыть edge‑кейсы (сбой загрузки фото, ошибки сети);
  - расширить автотесты/ручные сценарии на все ветки сохранения.

### 5.2 Улучшение UX

- Реализовано:
  - календарь с отметками дней, где есть блюда;
  - отдельная кнопка «Анализ блюда AI» на главном экране;
  - понятные пустые состояния для блюд и продуктов.
- В планах:
  - более быстрая навигация по дням (свайпы, кнопки «вчера/сегодня/завтра»);
  - группировка блюд по приёмам пищи (завтрак/обед/ужин/перекус);
  - дополнительные подсказки и онбординг.

### 5.3 Умный ИИ‑слой

- Реализовано:
  - базовый анализ фото и текста через OpenRouter (название блюда, описание, продукты);
  - обработка ошибок ИИ с показом понятных сообщений и возможностью повторить анализ;
  - fallback на ручной ввод (приложение остаётся полезным без ИИ).
- В планах:
  - использование более точной/платной модели OpenRouter при необходимости;
  - калибровка промпта под нутрицию (калории, БЖУ — последующие версии);
  - улучшение распознавания ингредиентов (синонимы, бренды, агрегация продуктов).

### 5.4 Профиль и персонализация

- Реализовано:
  - управление шаблонами блюд (`dish_templates`, `dish_template_products`);
  - быстрое добавление блюда по шаблону через экран `AddDishNoPhoto`;
  - разделение продуктов на «глобальные» и пользовательские;
  - экраны «Мои продукты» и «Основной список продуктов»;
  - редактирование имени пользователя в профиле.
- В планах:
  - расширенные настройки (уведомления, безопасность, экспорт данных);
  - дополнительные параметры профиля (цели по питанию и т.п.).

### 5.5 Аналитика рациона (следующие итерации)

- В планах:
  - счётчики:
    - количество блюд в день;
    - простая статистика по наиболее частым продуктам/блюдам;
  - интеграция нутриционных данных:
    - привязка продуктов к базе калорий/БЖУ;
    - отчёты за период (неделя/месяц) с агрегированной статистикой.

## 6. Принципы разработки

- Простые, короткие сценарии:
  - минимум шагов от фото до сохранённого блюда;
  - каждое действие — предсказуемый результат.
- ИИ — помощник, не обязательный шаг:
  - пользователь всегда может вручную поправить всё, что предложил ИИ;
  - приложение не ломается, если ИИ недоступен.
- Безопасность и приватность:
  - все данные пользователя изолированы RLS‑политиками Supabase;
  - доступ только к своим блюдам, продуктам и фото.

## 7. Модель данных Supabase и связи

### 7.1 Основные таблицы

- `saved_dishes` — блюда в дневнике пользователя:
  - `id`, `user_id`, `name`, `date`, `image_url`, `description`,
    `created_at`, `updated_at`.
- `products` — справочник продуктов:
  - `id`, `name`, `scope ('global'|'user')`, `created_by`, `created_at`,
    опционально `calories`, `protein`, `fats`, `carbs`.
- `dish_products` — связь «блюдо — продукт»:
  - `dish_id`, `product_id`, `is_user_added`.
- `dish_templates` — шаблоны блюд:
  - `id`, `user_id`, `name`, `created_at`.
- `dish_template_products` — связь «шаблон — продукт»:
  - `template_id`, `product_id`.

### 7.2 Связи между таблицами

- Один пользователь имеет много `saved_dishes`, `products (scope='user')`
  и `dish_templates`.
- Одно блюдо (`saved_dishes`) связано со многими продуктами через `dish_products`:
  - `dish_id` → `saved_dishes.id`;
  - `product_id` → `products.id`;
  - `is_user_added` показывает, добавлен ли продукт самим пользователем.
- Один шаблон (`dish_templates`) связан со многими продуктами через
  `dish_template_products`:
  - `template_id` → `dish_templates.id`;
  - `product_id` → `products.id`.

### 7.3 Сервисы и потоки данных

- Добавление блюда по фото (экран Camera):
  - ИИ возвращает название и продукты;
  - по отсутствующим продуктам создаются записи в `products` (`scope='user'`);
  - создаётся блюдо в `saved_dishes`;
  - связи блюдо–продукты записываются в `dish_products`.
- Добавление блюда без фото (экран AddDishNoPhoto):
  - режим «По описанию»:
    - ИИ анализирует текст и предложивает продукты;
  - режим «Из списка»:
    - продукты берутся из шаблона через `dish_templates` и `dish_template_products`;
  - дальше логика сохранения аналогична: новая запись в `saved_dishes`
    + связи в `dish_products`.
- Шаблоны блюд:
  - создаются в `dish_templates`;
  - их состав хранится в `dish_template_products` как список ссылок на `products`;
  - при использовании шаблона продукты подтягиваются и копируются в новое блюдо
    через `dish_products`.
