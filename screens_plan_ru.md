# Food AI — подробное описание экранов

## 1. Сплэш‑экран (Splash)

**Маршрут:** `/splash`  
**Файл:** `lib/core/router/app_router.dart` (класс `SplashScreen`)

- Фон: чёрный `#111111`.
- В центре надпись `FOOD AI` (белый текст, увеличенный интервал букв).
- Логика:
  - показывается ~1.2 секунды;
  - затем:
    - если Supabase не сконфигурирован — переход на `/`;
    - если пользователь авторизован — переход на `/` (главная);
    - если не авторизован — переход на `/login`.
- Кнопок нет, экран только для бренд‑заставки и маршрутизации.

## 2. Экран логина (Login)

**Маршрут:** `/login`  
**Файл:** `lib/features/auth/login_screen.dart`

Элементы:
- AppBar (может быть без заголовка либо с «Войти»).
- Поля ввода:
  - Email (`AppStrings.email`);
  - Пароль (`AppStrings.password`), скрытый ввод.
- Кнопки:
  - «Войти» (`FilledButton`):
    - по нажатию вызывает `login(email, password)` из `auth_service.dart`;
    - при успехе:
      - вызывает `onSuccess` (для роутера) или делает `context.go('/')`;
    - при ошибке показывает `SnackBar` с текстом ошибки.
  - «Регистрация» (текстовая кнопка/линк):
    - ведёт на `/register` через `context.go('/register')`.
  - «Забыли пароль?»:
    - открывает диалог ввода email;
    - отправляет запрос `resetPassword` на Supabase;
    - показывает `SnackBar` об успехе/ошибке.

Состояния:
- Прогресс‑индикатор при отправке запроса.
- Блокировка кнопки «Войти» пока форма невалидна или идёт запрос.

## 3. Экран регистрации (Register)

**Маршрут:** `/register`  
**Файл:** `lib/features/auth/register_screen.dart`

Элементы:
- Поля ввода:
  - Имя (`AppStrings.displayName`) — опционально;
  - Email;
  - Пароль.
- Кнопки:
  - «Зарегистрироваться»:
    - вызывает `register(email, password, displayName)` в `auth_service.dart`;
    - при успехе выполняет вход и переводит на `/`;
  - «Уже есть аккаунт? Войти»:
    - возвращает на `/login`.

Валидация:
- Проверка email на непустое значение и базовый формат.
- Минимальная длина пароля.

## 4. Главный экран (Home)

**Маршрут:** `/` (первая вкладка в нижней навигации)  
**Файл:** `lib/features/home/home_screen.dart`  
**Провайдеры:** `home_providers.dart`

Цель: показать календарь и список блюд за выбранный день и дать быстрый доступ к добавлению блюд.

Основные блоки:
- AppBar с заголовком `AppStrings.appTitle` (бренд Food AI).
- Календарь (`TableCalendar`):
  - верхняя часть экрана;
  - выбранная дата хранится в `selectedDateProvider`;
  - отмеченные даты (точки) берутся из `dishDatesInFocusedMonthProvider`.
- Кнопки действий под календарём:
  - «Анализ блюда AI» (`FilledButton.icon` с иконкой молнии):
    - открывает экран камеры `/camera`, где можно сфотографировать блюдо и запустить ИИ‑анализ;
  - «Добавить блюдо» (`OutlinedButton.icon`):
    - открывает экран `/add-no-photo?date=YYYY-MM-DD` с текущей выбранной датой;
    - используется для ручного добавления блюда без фото.
- Список блюд за выбранную дату:
  - данные из `dishesForSelectedDateProvider` (чтение `getDishesForDate`);
  - каждая карточка блюда:
    - превью‑фото (если есть, через `storage_service.dart` и signed URL);
    - название блюда;
    - дата (строкой);
    - кнопка «Подробнее», ведущая на экран «Подробнее о блюде» (`/dish/:id`).

Состояния:
- Загрузка (крутилка) пока подтягиваются блюда или отмеченные даты.
- Пустое состояние:
  - текст `AppStrings.noDishes` («Нет блюд на эту дату»).

## 5. Экран «Фото» (Camera / AI‑анализ)

**Маршрут:** `/camera` (вторая вкладка нижней навигации)  
**Файл:** `lib/features/camera/camera_screen.dart`

Цель: быстрее всего добавить блюдо по фото с анализом ИИ.

Блоки:
- AppBar с заголовком `AppStrings.addDish` или аналогичным.
- Блок выбора изображения:
  - кнопка «Сделать фото» (`AppStrings.takePhoto`) — `ImagePicker` c камерой;
  - кнопка «Выбрать из галереи» (`AppStrings.chooseFromGallery`).
  - после выбора:
    - отображается превью фото;
    - активируется кнопка «Анализировать» (если есть).
- Блок результата ИИ:
  - поле «Название блюда» (`AppStrings.dishName`) — заполняется из `AiAnalysisResult.dishName`;
  - поле «Описание» — из `AiAnalysisResult.description`;
  - список продуктов (`AppStrings.products`):
    - чекбоксы или чипы с продуктами, которые ИИ нашёл;
    - возможность удалить продукт из списка.
  - Кнопка «Добавить свой продукт»:
    - открывает диалог:
      - ввод названия;
      - при сохранении вызывает `insertProduct` (scope `user`, `created_by = user.id`);
      - добавляет созданный продукт в выбранные.
- Кнопка «Сохранить» (`AppStrings.save`):
  - логика `_save()`:
    1. Берёт текущего пользователя из `currentUserProvider`.
    2. Собирает список выбранных продуктов:
       - существующие — по id;
       - новые из `_selectedNamesNoId` добавляет в `products`.
    3. Если есть файл фото:
       - генерирует `dishId` (timestamp);
       - загружает файл в bucket `dish-images` через `uploadDishImage`;
       - получает `imageUrl`.
    4. Создаёт запись блюда через `insertDish`:
       - `userId`, `name`, `date`, `imageUrl`, `description`.
    5. Записывает связи блюдо–продукты через `setDishProducts`.
    6. Обновляет провайдер `dishesForSelectedDateProvider` и делает `context.go('/')`.
  - При ошибке показывает `SnackBar('Ошибка: $e')`.

Состояния:
- `_loading` — блокирует кнопки во время сохранения.
- Показывает крутилку вместо кнопки «Сохранить», если идёт операция.

## 6. Экран «Добавить без фото» (AddDishNoPhoto)

**Маршрут:** `/add-no-photo?date=YYYY-MM-DD`  
**Файл:** `lib/features/camera/add_dish_no_photo_screen.dart`

Цель: добавить блюдо руками, либо быстро создать его из готового шаблона без фото.

Элементы:
- AppBar: заголовок `AppStrings.addDishNoPhoto`, кнопка закрытия (иконка «крестик»).
- Переключатель режима (SegmentedButton):
  - «По описанию»:
    - пользователь вводит текстовое описание блюда или его название;
    - по нажатию на кнопку «Получить состав» текст отправляется в `analyzeDishDescription`;
    - ИИ возвращает название блюда и список продуктов.
  - «Из списка»:
    - использует заранее созданные шаблоны блюд (`dish_templates`);
    - выпадающий список с выбором шаблона;
    - при выборе шаблона подставляется название и состав продуктов.
- Блок редактирования блюда (появляется, когда форма готова):
  - поле `AppStrings.dishName` — редактируемое название блюда;
  - список продуктов (`AppStrings.products`) в виде `FilterChip`:
    - можно включать/выключать продукты;
    - недостающие продукты создаются как пользовательские (`scope = 'user'`).
  - кнопка «Добавить свой продукт»:
    - открывает диалог с поиском по существующим продуктам;
    - позволяет создать новый продукт, связанный с текущим пользователем.
- Кнопка «Сохранить»:
  - создаёт запись блюда в `saved_dishes` с датой из query‑параметра или текущей;
  - записывает связи в `dish_products`;
  - обновляет блюда на главном экране и возвращает пользователя назад.
- Кнопка «Отмена»:
  - закрывает экран без сохранения.

## 7. Экран «Подробнее о блюде» (DishDetail)

**Маршрут:** `/dish/:id`  
**Файл:** `lib/features/dish_detail/dish_detail_screen.dart`

Цель: показать детальную информацию о блюде и его составе.

Данные:
- Загрузка блюда `DishRecord` через `getDishById(dishId)`;
- Загрузка списка продуктов через `getProductsForDish(dishId)`.

Элементы:
- AppBar:
  - заголовок `AppStrings.dishDetail`;
  - кнопка «Назад» (стрелка);
  - меню/кнопка «Удалить»:
    - вызывает `deleteDish(dishId)` и `deleteDishProducts` для связей;
    - возвращает на предыдущий экран.
- Тело:
  - фото блюда, если есть (`imageUrl` + `storage_service.dart`);
  - название блюда;
  - дата;
  - описание (`AppStrings.composition` / «Состав»);
  - список продуктов:
    - карточки со строками продуктов;
    - возможно, отметка, какие продукты были добавлены пользователем (поле `is_user_added`).
- Кнопка редактирования:
  - изменение названия/описания;
  - добавление/удаление продуктов:
    - при добавлении создаётся новая запись продукта (`products`) при необходимости и связь в `dish_products`;
    - при удалении — удаляется запись из `dish_products`.

## 8. Экран «Профиль» (Profile)

**Маршрут:** `/profile` (третья вкладка нижней навигации)  
**Файл:** `lib/features/profile/profile_screen.dart`

Цель: управление учёткой и справочниками (продукты, шаблоны).

Элементы:
- AppBar: заголовок `AppStrings.profile`.
- Блок пользователя:
  - имя из `ProfileRecord` (`profile_service.dart`);
  - email из Supabase `User`;
  - в будущем — аватар.
- Список настроек/разделов:
  - «Мои продукты» (`AppStrings.myProducts`):
    - открывает `ProfileProductsScreen`;
  - «Основной список продуктов» (`AppStrings.mainProductList`):
    - открывает `GlobalProductsScreen`;
  - «Шаблоны блюд»:
    - открывает `TemplatesScreen`.
- Кнопка «Выйти» (`AppStrings.signOut`):
  - вызывает `logout()` из `auth_service.dart`;
  - сбрасывает текущего пользователя и возвращает на `/login`.

## 9. Экран «Мои продукты» (ProfileProductsScreen)

**Маршрут:** из профиля, отдельный `Navigator.push`  
**Файл:** `lib/features/profile/profile_products_screen.dart`

Цель: управлять личными продуктами пользователя (scope `user`).

Элементы:
- AppBar:
  - заголовок `AppStrings.myProducts`;
  - стрелка «Назад».
- Тело:
  - состояние «нет продуктов»:
    - текст «Нет своих продуктов»;
    - кнопка `FilledButton.icon` «Добавить продукт».
  - список продуктов:
    - `ListView` с карточками;
    - каждый элемент:
      - название продукта;
      - иконка корзины:
        - по нажатию вызывает диалог подтверждения;
        - при подтверждении — `deleteProduct(id)` и обновление списка.
- FAB:
  - иконка «+»;
  - по нажатию — диалог добавления продукта:
    - текстовое поле «Название»;
    - при сохранении — `insertProduct(scope: 'user', created_by: user.id)`;  
    - обновление списка.

## 10. Экран «Основной список продуктов» (GlobalProductsScreen)

**Маршрут:** из профиля  
**Файл:** `lib/features/profile/global_products_screen.dart`

Цель: показать глобальный (общий) список продуктов, доступных всем.

Элементы:
- AppBar: `AppStrings.mainProductList`.
- Список:
  - только чтение (как минимум в текущей версии);
  - продукты scope `global`:
    - подгружаются из `getProducts(scope: 'global')`;
    - используются при выборе продуктов для блюда.

В будущем:
- Можно добавить фильтры/поиск.

## 11. Экран «Шаблоны блюд» (TemplatesScreen)

**Маршрут:** из профиля  
**Файл:** `lib/features/profile/templates_screen.dart`

Цель: заранее собирать «шаблоны» блюд (например, «Овсянка с бананом»), чтобы быстро добавлять их в разные дни.

Элементы:
- AppBar: заголовок «Списки блюд» или аналогичный.
- Тело:
  - если нет шаблонов:
    - текст «Нет списков»;
    - кнопка «Создать список».
  - если есть:
    - `ListView` карточек:
      - название шаблона;
      - стрелка «>»;
      - тап по шаблону:
        - открывает `TemplateEditScreen` для редактирования.
- FAB:
  - кнопка «+»:
    - диалог создания нового шаблона (`insertTemplate`).

## 12. Экран редактирования шаблона (TemplateEditScreen)

**Маршрут:** из TemplatesScreen  
**Файл:** `lib/features/profile/template_edit_screen.dart`

Цель: управлять названием шаблона и списком продуктов, входящих в него.

Элементы:
- AppBar:
  - заголовок — название шаблона;
  - кнопка удаления:
    - показывает диалог «Удалить список?»;
    - при подтверждении вызывает `deleteTemplate(id)` и возвращает назад.
- Тело:
  - текстовое поле названия шаблона;
  - список продуктов шаблона:
    - берётся через `getTemplateProducts(templateId)`;
    - элементы списка можно удалять.
  - кнопка «Добавить продукт в список»:
    - открывает диалог выбора продукта:
      - список продуктов с поиском;
      - tap по продукту — добавляет в шаблон (`setTemplateProducts` / `addTemplateProduct`).
- Кнопка «Сохранить»:
  - обновляет название (`updateTemplate`);
  - сохраняет состав шаблона (через `setTemplateProducts`).

## 13. Поведение нижней навигации

**Файл:** `lib/core/router/app_router.dart`, класс `ScaffoldWithNavBar`

Вкладки:
- «Главная»:
  - иконка календаря;
  - маршрут `/`.
- «Фото»:
  - иконка камеры;
  - маршрут `/camera`.
- «Профиль»:
  - иконка пользователя;
  - маршрут `/profile`.

Поведение:
- При нажатии на вкладку:
  - `navigationShell.goBranch(index, initialLocation: index == currentIndex)`;
  - повторный тап по активной вкладке возвращает на корневой экран ветки (сброс вложенных маршрутов).
